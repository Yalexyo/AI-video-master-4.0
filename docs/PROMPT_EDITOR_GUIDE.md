# 🧪 Prompt配置实时编辑器使用指南

## 📍 **访问路径**
```
主页 → 🧱 组装工厂 → 🤖 AI模型Prompt配置 → 👁️ Qwen视觉Prompt → ✏️ 编辑配置
```

## 🎯 **功能特性**

### ✅ **实时预览**
- 编辑后点击"🔄 更新预览"立即看到Prompt效果
- 配置变更摘要显示修改内容
- 配置质量检查确保格式正确

### ✅ **手动保存**
- 满意后点击"💾 保存到配置文件"永久保存
- 自动删除重复配置，优化文件结构
- 保存后自动重新加载配置缓存

### ✅ **安全机制**
- 修改先存储在session state，不会立即覆盖文件
- 支持"❌ 取消修改"和"🔄 重置所有编辑"
- 配置质量检查防止错误配置

## 📝 **详细使用步骤**

### **Step 1: 编辑配置**
```
✏️ 编辑配置标签页
├── 🔧 基础识别字段
│   ├── 视觉对象 (用、分隔)
│   ├── 场景类别 (用、分隔)  
│   ├── 情绪类别 (用 / 分隔)
│   └── 品牌关键词 (用、分隔)
├── 🎯 重点品牌识别强化
│   ├── 优先品牌 (启赋、illuma、Wyeth、A2、HMO)
│   ├── 品牌相关对象 (logo、标识、包装)
│   └── 成分表相关 (成分表、配料表)
└── 🚨 特殊信号配置
    ├── 痛点信号 (医院、哭闹等)
    └── 活力信号 (宝宝开心、户外玩耍等)
```

### **Step 2: 更新预览**
```
1. 填写完配置后点击 [🔄 更新预览] 按钮
2. 系统将配置存储到 st.session_state.edited_config
3. 切换到 "👀 预览Prompt" 标签页查看效果
```

### **Step 3: 查看预览效果**
```
👀 预览Prompt标签页显示：
├── 📊 配置变更摘要 (显示修改的项目)
├── 👁️ Qwen视觉分析Prompt (完整预览)
├── 🔄 Qwen重试Prompt预览 (补抓机制)
├── 📊 统计信息 (长度、关键词数量)
├── 🔍 配置质量检查 (验证格式)
└── 🧪 测试Prompt生成 (验证模板)
```

### **Step 4: 保存配置**
```
💾 保存配置标签页：
├── 📋 待保存的修改列表
├── [💾 保存到配置文件] - 永久保存
├── [🔄 重新加载配置] - 从文件重新加载  
└── [❌ 取消修改] - 放弃当前修改
```

## 🔧 **保存机制详解**

### **临时存储 (Session State)**
```python
# 编辑的配置临时存储，不影响原文件
st.session_state.edited_config = {
    "visual_objects": "奶粉罐、奶瓶、宝宝、妈妈",
    "priority_brands": "启赋、illuma、Wyeth、A2、HMO",
    # ...
}
```

### **文件保存逻辑**
```python
def _save_config_to_file(edited_config):
    """
    保存流程：
    1. 读取当前 config/keywords.yml 
    2. 将编辑的配置合并到正确的配置结构中
    3. 删除重复的 brand_emphasis 配置
    4. 写回文件，保持YAML格式
    5. 重新加载配置缓存 reload_config()
    """
```

### **配置结构优化**
```yaml
# 🚨 自动优化：删除重复配置
# ❌ 删除: brand_emphasis (重复配置)
# ✅ 保留: brands.all_brands + brands.priority_brands

# 优化前（有重复）
brands: ["启赋", "illuma", "Wyeth"]
brand_emphasis:
  priority_brands: ["启赋", "illuma"]  # ← 重复

# 优化后（无重复）  
brands:
  all_brands: ["启赋", "illuma", "Wyeth", "A2", "HMO"]
  priority_brands: ["启赋", "illuma", "Wyeth", "A2", "HMO"]
```

## ⚡ **快速操作**

### **常用快捷操作**
- `🔄 更新预览`: 预览编辑效果
- `💾 保存到配置文件`: 永久保存修改
- `🔄 重新加载配置`: 从文件重新加载
- `🔄 重置所有编辑`: 清空编辑内容
- `🧪 测试Prompt生成`: 验证配置有效性

### **配置验证**
```
✅ 自动检查：
├── 必需字段是否为空
├── 情绪类别是否为5个
├── 重点品牌数量是否合理
├── Prompt模板生成是否成功
└── 配置文件格式是否正确
```

## 🚨 **注意事项**

### **⚠️ 重要提醒**
1. **不是实时保存**：修改后需要手动保存
2. **先预览后保存**：确认效果满意再保存
3. **支持回滚**：可以重新加载配置取消修改
4. **配置验证**：保存前会检查配置质量

### **🔒 安全机制**
- 修改存储在内存中，不会意外覆盖文件
- 保存前有确认和预览机制
- 支持配置回滚和重置
- 自动备份和缓存重新加载

## 📍 **访问测试版**
```bash
# 独立测试版（可选）
streamlit run test_prompt_editor.py --server.port 8513
# 访问: http://localhost:8513
```

---

**🎯 总结**：这是一个安全的、可预览的、手动保存的Prompt配置编辑器，确保你可以安全地修改和测试配置，满意后再保存。 